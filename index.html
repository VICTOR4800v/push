<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracker Attivit√† Progressiva</title>

  <!-- Stili (identici all'originale) -->
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .login-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-container h1 { color:#333; margin-bottom:10px; font-size:28px; }
    .login-container p { color:#666; margin-bottom:30px; font-size:14px; }
    .login-container input {
      width:100%; padding:12px; margin-bottom:20px;
      border:2px solid #ddd; border-radius:10px; font-size:16px;
      transition:border-color 0.3s;
    }
    .login-container input:focus { outline:none; border-color:#667eea; }
    .login-container button {
      width:100%; padding:12px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white; border:none; border-radius:10px;
      font-size:16px; font-weight:bold; cursor:pointer;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .login-container button:hover {
      transform:translateY(-2px);
      box-shadow:0 10px 20px rgba(102,126,234,0.4);
    }
    .error-message { color:#e74c3c; font-size:14px; margin-bottom:15px; display:none; }

    .main-container { display:none; width:100%; background:linear-gradient(to bottom right,#0f3460,#16213e); min-height:100vh; padding:20px; }
    .main-container.show { display:block; }

    .max-w-7xl { max-width:1280px; margin:0 auto; }
    .header { background:white; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:30px; margin-bottom:30px; }
    .header-top { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px; margin-bottom:25px; }
    .header-title h1 { font-size:32px; color:#333; margin:0; }
    .sync-status { font-size:12px; color:#666; display:flex; align-items:center; gap:6px; }
    .sync-status.synced .dot { background:#27ae60; }
    .sync-status.syncing .dot { background:#f39c12; animation:pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
    .dot { width:8px; height:8px; border-radius:50%; }
    .logout-btn { padding:10px 20px; background:#e74c3c; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:background 0.3s; }
    .logout-btn:hover { background:#c0392b; }
    .month-selector { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
    .month-btn { padding:10px 16px; border:2px solid #ddd; background:white; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s; }
    .month-btn.active { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border-color:transparent; transform:scale(1.05); box-shadow:0 5px 15px rgba(102,126,234,0.4); }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .stat-card { background:white; border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.2); text-align:center; }
    .stat-label { color:#666; font-size:14px; font-weight:600; margin-bottom:10px; }
    .stat-value { font-size:36px; font-weight:bold; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .table-container { background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden; margin-bottom:30px; }
    .table-header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:20px; font-size:18px; font-weight:bold; }
    .table-wrapper { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    th { background:#f8f9fa; padding:15px; text-align:left; font-weight:600; color:#666; font-size:12px; text-transform:uppercase; border-bottom:2px solid #e9ecef; }
    td { padding:15px; border-bottom:1px solid #e9ecef; }
    tr:hover { background:#f8f9fa; }
    input[type="number"] { width:100px; padding:8px; border:2px solid #ddd; border-radius:6px; font-size:14px; transition:border-color 0.3s; }
    input[type="number"]:focus { outline:none; border-color:#667eea; }
    .complete-btn { padding:8px 16px; border:none; border-radius:6px; font-weight:600; cursor:pointer; transition:all 0.3s; font-size:14px; }
    .complete-btn.done { background:#27ae60; color:white; }
    .complete-btn.pending { background:#ecf0f1; color:#333; }
    .missing { font-weight:bold; font-size:14px; }
    .missing.positive { color:#e74c3c; }
    .missing.zero { color:#27ae60; }
    .missing.negative { color:#3498db; }
    .summaries { background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:25px; }
    .summary-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
    .summary-card { padding:20px; border-radius:12px; border:2px solid #e9ecef; }
    .summary-card.final { background:linear-gradient(135deg,rgba(102,126,234,0.1) 0%,rgba(118,75,162,0.1) 100%); border:2px solid #667eea; }
    .summary-item { display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; }
    .blue{color:#3498db;} .green{color:#27ae60;} .orange{color:#e67e22;}
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div class="login-container" id="loginContainer">
    <h1>üîí Accedi</h1>
    <p>Inserisci la password per continuare</p>
    <div class="error-message" id="errorMessage">Password non corretta!</div>
    <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
    <button onclick="handleLogin()"><span id="loginButtonText">Accedi</span></button>
  </div>

  <!-- MAIN APP -->
  <div class="main-container" id="mainContainer">
    <div class="max-w-7xl">
      <div class="header">
        <div class="header-top">
          <div class="header-title"><h1>üìä Tracker Attivit√†</h1></div>
          <div style="display:flex;align-items:center;gap:20px;">
            <div class="sync-status synced" id="syncStatus">
              <div class="dot"></div><span id="syncText">Sincronizzato</span>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Esci</button>
          </div>
        </div>
        <div class="month-selector" id="monthSelector"></div>
      </div>

      <div class="stats-grid" id="statsGrid"></div>
      <div class="table-container">
        <div class="table-header" id="tableHeader">Ottobre 2025</div>
        <div class="table-wrapper">
          <table id="daysTable">
            <thead>
              <tr>
                <th>Giorno</th><th>Target Progressivo</th><th>Completati</th><th>Mancanti</th><th>Azione</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="summaries">
        <h2>üìà Riepiloghi</h2>
        <div class="summary-grid" id="summaryGrid"></div>
      </div>
    </div>
  </div>

  <!-- JS MODULARE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
    import CryptoJS from "https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/+esm";

    const firebaseConfig = {
      apiKey: "AIzaSyBfFmbNASeRU5T12O9WTUCtzvsfMlFFQ18",
      authDomain: "tracker-attivita.firebaseapp.com",
      databaseURL: "https://tracker-attivita-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "tracker-attivita",
      storageBucket: "tracker-attivita.firebasestorage.app",
      messagingSenderId: "857694304901",
      appId: "1:857694304901:web:c4ff52a70b6fec3e1907ec"
    };

    const PASSWORD_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; // "admin"
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentMonth = 9, currentYear = 2025;
    let completamenti = {}, isSyncing = false, userAuth = null;
    const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];

    function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      const hash = CryptoJS.SHA256(password).toString();
      if (hash === PASSWORD_HASH) {
        userAuth = hash.substring(0,16);
        document.getElementById('loginContainer').style.display='none';
        document.getElementById('mainContainer').classList.add('show');
        loadDataFromFirebase();
        initApp();
      } else {
        document.getElementById('errorMessage').style.display='block';
        document.getElementById('passwordInput').value='';
      }
    }

    function handleLogout() {
      document.getElementById('loginContainer').style.display='flex';
      document.getElementById('mainContainer').classList.remove('show');
      document.getElementById('passwordInput').value='';
      document.getElementById('errorMessage').style.display='none';
      completamenti={}; userAuth=null;
    }

    function updateSyncStatus(syncing){
      const status=document.getElementById('syncStatus'), text=document.getElementById('syncText');
      if(syncing){status.className='sync-status syncing';text.textContent='Sincronizzazione...';}
      else {status.className='sync-status synced';text.textContent='Sincronizzato';}
    }

    function loadDataFromFirebase(){
      updateSyncStatus(true);
      const userRef = ref(db, 'utenti/' + userAuth);
      onValue(userRef,(snapshot)=>{
        if(snapshot.exists()){
          const data=snapshot.val();
          completamenti=data.completamenti||{};
        }
        updateSyncStatus(false);
        render();
      });
    }

    function saveDataToFirebase(){
      if(isSyncing) return;
      isSyncing=true; updateSyncStatus(true);
      const userRef = ref(db,'utenti/'+userAuth);
      set(userRef,{completamenti,ultimoAggiornamento:new Date().toISOString()})
      .then(()=>{isSyncing=false;updateSyncStatus(false);})
      .catch((err)=>{console.error(err);isSyncing=false;updateSyncStatus(false);});
    }

    function giorniDelMese(m,a){return new Date(a,m+1,0).getDate();}
    function calcolaTargetGiorno(m,g){let tot=0;for(let i=0;i<m;i++)tot+=giorniDelMese(i,currentYear);tot+=g;return tot*3;}

    function getDatiMese(){
      const giorni=giorniDelMese(currentMonth,currentYear);
      const dati=[];
      for(let g=1;g<=giorni;g++){
        const chiave=`${currentYear}-${currentMonth}-${g}`;
        const target=calcolaTargetGiorno(currentMonth,g);
        const completato=completamenti[chiave]||0;
        dati.push({giorno:g,chiave,target,completato,mancante:target-completato});
      }
      return dati;
    }

    function renderMonthSelector(){
      const sel=document.getElementById('monthSelector'); sel.innerHTML='';
      mesi.forEach((m,idx)=>{
        const btn=document.createElement('button');
        btn.className=`month-btn ${idx===currentMonth?'active':''}`;
        btn.textContent=m;
        btn.onclick=()=>{currentMonth=idx;render();};
        sel.appendChild(btn);
      });
    }

    function renderTable(){
      const dati=getDatiMese();
      const tbody=document.getElementById('tableBody');
      document.getElementById('tableHeader').textContent=`${mesi[currentMonth]} ${currentYear}`;
      tbody.innerHTML='';
      dati.forEach(d=>{
        const row=document.createElement('tr');
        const isDone=completamenti[d.chiave]===d.target;
        row.innerHTML=`
          <td>Giorno ${d.giorno}</td>
          <td><strong>${d.target}</strong></td>
          <td><input type="number" value="${completamenti[d.chiave]||''}" min="0"
              onchange="updateCompletamento('${d.chiave}', this.value)"></td>
          <td><span class="missing ${d.mancante===0?'zero':d.mancante>0?'positive':'negative'}">
              ${d.mancante>0?'+':''}${d.mancante}</span></td>
          <td><button class="complete-btn ${isDone?'done':'pending'}"
              onclick="toggleComplete('${d.chiave}',${d.target})">${isDone?'‚úì Fatto':'Completa'}</button></td>`;
        tbody.appendChild(row);
      });
    }

    function renderStats(){
      const dati=getDatiMese();
      const target=dati[dati.length-1].target;
      const completato=dati.reduce((s,d)=>s+d.completato,0);
      const manc=target-completato;
      document.getElementById('statsGrid').innerHTML=`
        <div class="stat-card"><div class="stat-label">üìÖ Target Mensile</div><div class="stat-value blue">${target}</div></div>
        <div class="stat-card"><div class="stat-label">‚úÖ Completati</div><div class="stat-value green">${completato}</div></div>
        <div class="stat-card"><div class="stat-label">‚è≥ Mancanti</div><div class="stat-value orange">${manc}</div></div>`;
    }

    function renderSummaries(){
      const dati=getDatiMese();
      const grid=document.getElementById('summaryGrid'); grid.innerHTML='';
      const chunks=[];
      for(let i=10;i<=dati.length;i+=10){
        const dec=dati.slice(0,i);
        const t=dec[dec.length-1].target;
        const c=dec.reduce((s,d)=>s+d.completato,0);
        chunks.push({giorni:`${i-9}-${i}`,target:t,completato:c,mancante:t-c});
      }
            const tTot = dati[dati.length - 1].target;
      const cTot = dati.reduce((s, d) => s + d.completato, 0);
      chunks.push({ giorni: 'Totale', target: tTot, completato: cTot, mancante: tTot - cTot, finale: true });

      chunks.forEach(riepilogo => {
        const card = document.createElement('div');
        card.className = `summary-card ${riepilogo.finale ? 'final' : ''}`;
        const percentuale = riepilogo.target > 0 ? ((riepilogo.completato / riepilogo.target) * 100).toFixed(1) : 0;
        card.innerHTML = `
          <h3>${riepilogo.finale ? 'üèÅ ' : 'üìä '}Giorni ${riepilogo.giorni}</h3>
          <div class="summary-item"><span class="summary-label">Target:</span><span class="summary-value blue">${riepilogo.target}</span></div>
          <div class="summary-item"><span class="summary-label">Completati:</span><span class="summary-value green">${riepilogo.completato}</span></div>
          <div class="summary-item"><span class="summary-label">Mancanti:</span><span class="summary-value ${riepilogo.mancante === 0 ? 'green' : 'orange'}">${riepilogo.mancante}</span></div>
          ${riepilogo.completato > 0 ? `
          <div class="summary-item" style="border-top:1px solid #ddd; margin-top:10px; padding-top:10px;">
            <span class="summary-label">Percentuale:</span>
            <span class="summary-value blue">${percentuale}%</span>
          </div>` : ''}
        `;
        grid.appendChild(card);
      });
    }

    function updateCompletamento(chiave, valore) {
      if (valore === '') {
        delete completamenti[chiave];
      } else {
        completamenti[chiave] = Number(valore);
      }
      saveDataToFirebase();
      render();
    }

    function toggleComplete(chiave, target) {
      if (completamenti[chiave] === target) {
        delete completamenti[chiave];
      } else {
        completamenti[chiave] = target;
      }
      saveDataToFirebase();
      render();
    }

    function render() {
      renderTable();
      renderStats();
      renderSummaries();
    }

    function initApp() {
      renderMonthSelector();
      render();
    }

    // Permette di premere "Enter" per fare login
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('passwordInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
    });

    // Esponiamo le funzioni globalmente per usare gli onclick inline nel HTML
    window.updateCompletamento = updateCompletamento;
    window.toggleComplete = toggleComplete;
    window.handleLogin = handleLogin;
    window.handleLogout = handleLogout;

  </script>
</body>
</html>

