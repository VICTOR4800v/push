<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Attivit√† Progressiva</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #c7d2fe 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 2rem;
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .login-box input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .login-box button {
            width: 100%;
            padding: 0.75rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-box button:hover {
            background: #4338ca;
        }

        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .container {
            max-width: 90rem;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-title h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1e293b;
        }

        .icon {
            width: 2rem;
            height: 2rem;
            color: #4f46e5;
        }

        .month-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .month-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #334155;
        }

        .month-btn:hover {
            background: #e2e8f0;
        }

        .month-btn.active {
            background: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
            transform: scale(1.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .stat-header h3 {
            font-weight: 600;
            color: #475569;
            font-size: 0.875rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .day-cell {
            font-weight: 600;
            color: #1e293b;
        }

        .target-cell {
            font-weight: 600;
            color: #0f172a;
        }

        .input-number {
            width: 6rem;
            padding: 0.5rem 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .input-number:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .missing-positive {
            color: #ea580c;
            font-weight: 600;
        }

        .missing-zero {
            color: #16a34a;
            font-weight: 600;
        }

        .missing-negative {
            color: #2563eb;
            font-weight: 600;
        }

        .complete-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .complete-btn.completed {
            background: #22c55e;
            color: white;
        }

        .complete-btn.incomplete {
            background: #e2e8f0;
            color: #475569;
        }

        .complete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .summary-card {
            padding: 1rem;
            border-radius: 0.75rem;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
        }

        .summary-card.final {
            background: #eef2ff;
            border-color: #c7d2fe;
        }

        .summary-card h3 {
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .summary-label {
            color: #64748b;
        }

        .summary-value {
            font-weight: 600;
        }

        .summary-divider {
            border-top: 1px solid #cbd5e1;
            margin: 0.5rem 0;
        }

        .section-header {
            background: #4f46e5;
            padding: 1rem 1.5rem;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .section-header h2 {
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            th, td {
                padding: 0.5rem;
                font-size: 0.875rem;
            }

            .input-number {
                width: 4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>üîí Accesso Tracker</h1>
            <input type="password" id="passwordInput" placeholder="Inserisci password" />
            <button onclick="login()">Accedi</button>
            <div id="errorMessage" class="error-message hidden">Password errata!</div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <!-- Header -->
            <div class="card">
                <div class="header">
                    <div class="header-title">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        <h1>Tracker Attivit√† Progressiva</h1>
                    </div>
                </div>
                
                <!-- Month Selector -->
                <div class="month-selector" id="monthSelector"></div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid" id="quickStats"></div>

            <!-- Daily Table -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div class="section-header">
                    <h2 id="monthTitle"></h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Giorno</th>
                                <th>Target Progressivo</th>
                                <th>Completati</th>
                                <th>Mancanti</th>
                                <th>Azione</th>
                            </tr>
                        </thead>
                        <tbody id="dailyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Summaries -->
            <div class="card">
                <h2 style="font-size: 1.25rem; font-weight: bold; color: #1e293b; margin-bottom: 1rem;">Riepiloghi</h2>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // CONFIGURAZIONE FIREBASE - Sostituisci con le tue credenziali
        const firebaseConfig = {
              apiKey: "AIzaSyBfFmbNASeRU5T12O9WTUCtzvsfMlFFQ18",
  authDomain: "tracker-attivita.firebaseapp.com",
  databaseURL: "https://tracker-attivita-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tracker-attivita",
  storageBucket: "tracker-attivita.firebasestorage.app",
  messagingSenderId: "857694304901",
  appId: "1:857694304901:web:c4ff52a70b6fec3e1907ec"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Constants
        const PASSWORD = "mypassword";
        const INCREMENT = 3;
        const MONTHS = [
            'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
            'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
        ];
        
        // State
        let currentYear = 2025;
        let currentMonth = 9; // Ottobre (0-based)
        let completions = {};

        // Login Function
        window.login = function() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('errorMessage');
            
            if (input.value === PASSWORD) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                init();
            } else {
                error.classList.remove('hidden');
                input.value = '';
                setTimeout(() => error.classList.add('hidden'), 3000);
            }
        };

        // Enter key for login
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('passwordInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') window.login();
                });
            }
        });

        // Utility Functions
        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function calculateProgressiveTarget(month, day) {
            let totalDays = 0;
            
            // Sum all days from previous months (starting from October)
            for (let m = 9; m < month; m++) {
                totalDays += getDaysInMonth(m, currentYear);
            }
            // If we're in a month before October, add days from October to December of previous year
            if (month < 9) {
                for (let m = 9; m < 12; m++) {
                    totalDays += getDaysInMonth(m, currentYear - 1);
                }
                // Then add days from January to current month
                for (let m = 0; m < month; m++) {
                    totalDays += getDaysInMonth(m, currentYear);
                }
            }
            
            totalDays += day;
            return totalDays * INCREMENT;
        }

        // Firebase Functions
        async function loadCompletionsFromFirebase() {
            const dbRef = ref(database, 'completions');
            const snapshot = await get(dbRef);
            if (snapshot.exists()) {
                completions = snapshot.val();
            } else {
                completions = {};
            }
        }

        function saveCompletionToFirebase(key, value) {
            const dbRef = ref(database, `completions/${key}`);
            set(dbRef, value);
        }

        function setupRealtimeListener() {
            const dbRef = ref(database, 'completions');
            onValue(dbRef, (snapshot) => {
                if (snapshot.exists()) {
                    completions = snapshot.val();
                    renderAll();
                }
            });
        }

        // Render Functions
        function renderMonthSelector() {
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = '';
            
            MONTHS.forEach((month, idx) => {
                const btn = document.createElement('button');
                btn.className = `month-btn ${idx === currentMonth ? 'active' : ''}`;
                btn.textContent = month;
                btn.onclick = () => {
                    currentMonth = idx;
                    renderAll();
                };
                selector.appendChild(btn);
            });
        }

        function generateMonthData() {
            const days = getDaysInMonth(currentMonth, currentYear);
            const data = [];
            
            for (let d = 1; d <= days; d++) {
                const key = `${currentYear}-${currentMonth}-${d}`;
                const target = calculateProgressiveTarget(currentMonth, d);
                const completed = completions[key] !== undefined ? completions[key] : null;
                
                data.push({
                    day: d,
                    key: key,
                    target: target,
                    completed: completed,
                    missing: completed !== null ? target - completed : null
                });
            }
            
            return data;
        }

        function calculateSummaries(monthData) {
            const summaries = [];
            const days = monthData.length;
            
            // Summaries every 10 days
            for (let i = 10; i <= days; i += 10) {
                const subset = monthData.slice(0, i);
                const targetTotal = subset[subset.length - 1].target;
                const completedTotal = subset.reduce((sum, d) => sum + (d.completed || 0), 0);
                
                summaries.push({
                    dayEnd: i,
                    target: targetTotal,
                    completed: completedTotal,
                    missing: targetTotal - completedTotal,
                    final: false
                });
            }
            
            // Monthly final summary
            const targetMonthly = monthData[monthData.length - 1].target;
            const completedMonthly = monthData.reduce((sum, d) => sum + (d.completed || 0), 0);
            
            summaries.push({
                dayEnd: days,
                target: targetMonthly,
                completed: completedMonthly,
                missing: targetMonthly - completedMonthly,
                final: true
            });
            
            return summaries;
        }

        function renderQuickStats(summaries) {
            const container = document.getElementById('quickStats');
            const finalSummary = summaries.find(s => s.final);
            
            if (!finalSummary) return;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <h3>Target Mensile</h3>
                    </div>
                    <p class="stat-value" style="color: #2563eb;">${finalSummary.target}</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <h3>Completati</h3>
                    </div>
                    <p class="stat-value" style="color: #16a34a;">${finalSummary.completed}</p>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <svg class="icon" style="width: 1.5rem; height: 1.5rem; color: #ea580c;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <h3>Mancanti</h3>
                    </div>
                    <p class="stat-value" style="color: #ea580c;">${finalSummary.missing}</p>
                </div>
            `;
        }

        function renderDailyTable(monthData) {
            const tbody = document.getElementById('dailyTableBody');
            tbody.innerHTML = '';
            
            monthData.forEach(data => {
                const tr = document.createElement('tr');
                
                const missingClass = data.missing === null ? '' : 
                    data.missing === 0 ? 'missing-zero' : 
                    data.missing > 0 ? 'missing-positive' : 'missing-negative';
                
                const missingText = data.missing === null ? '' :
                    data.missing > 0 ? `+${data.missing}` : data.missing;
                
                const isCompleted = data.completed === data.target;
                
                tr.innerHTML = `
                    <td class="day-cell">Giorno ${data.day}</td>
                    <td class="target-cell">${data.target}</td>
                    <td>
                        <input type="number" 
                               class="input-number" 
                               value="${data.completed !== null ? data.completed : ''}" 
                               placeholder="0"
                               min="0"
                               data-key="${data.key}">
                    </td>
                    <td><span class="${missingClass}">${missingText}</span></td>
                    <td>
                        <button class="complete-btn ${isCompleted ? 'completed' : 'incomplete'}" 
                                data-key="${data.key}" 
                                data-target="${data.target}">
                            ${isCompleted ? '‚úì Fatto' : 'Completa'}
                        </button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Add event listeners
            tbody.querySelectorAll('input.input-number').forEach(input => {
                input.addEventListener('change', (e) => {
                    const key = e.target.dataset.key;
                    const value = e.target.value ? Number(e.target.value) : null;
                    completions[key] = value;
                    saveCompletionToFirebase(key, value);
                    renderAll();
                });
            });
            
            tbody.querySelectorAll('button.complete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const key = e.target.dataset.key;
                    const target = Number(e.target.dataset.target);
                    completions[key] = completions[key] === target ? null : target;
                    saveCompletionToFirebase(key, completions[key]);
                    renderAll();
                });
            });
        }

        function renderSummaries(summaries) {
            const container = document.getElementById('summaryGrid');
            container.innerHTML = '';
            
            summaries.forEach(summary => {
                const div = document.createElement('div');
                div.className = `summary-card ${summary.final ? 'final' : ''}`;
                
                const percentage = summary.completed > 0 ? 
                    ((summary.completed / summary.target) * 100).toFixed(1) : '0.0';
                
                div.innerHTML = `
                    <h3>${summary.final ? 'üèÅ Totale Mensile' : `üìä Giorni 1-${summary.dayEnd}`}</h3>
                    <div class="summary-row">
                        <span class="summary-label">Target:</span>
                        <span class="summary-value" style="color: #2563eb;">${summary.target}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Completati:</span>
                        <span class="summary-value" style="color: #16a34a;">${summary.completed}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Mancanti:</span>
                        <span class="summary-value" style="color: ${summary.missing === 0 ? '#16a34a' : '#ea580c'};">${summary.missing}</span>
                    </div>
                    ${summary.completed > 0 ? `
                        <div class="summary-divider"></div>
                        <div class="summary-row">
                            <span class="summary-label">Percentuale:</span>
                            <span class="summary-value" style="color: #4f46e5;">${percentage}%</span>
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(div);
            });
        }

        function renderAll() {
            document.getElementById('monthTitle').textContent = `${MONTHS[currentMonth]} ${currentYear}`;
            renderMonthSelector();
            
            const monthData = generateMonthData();
            const summaries = calculateSummaries(monthData);
            
            renderQuickStats(summaries);
            renderDailyTable(monthData);
            renderSummaries(summaries);
        }

        // Initialize
        async function init() {
            await loadCompletionsFromFirebase();
            setupRealtimeListener();
            renderAll();
        }
    </script>
</body>
</html>
